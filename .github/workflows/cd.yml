name: CD - Hush Web Client

on:
  # Trigger on version tags
  push:
    tags:
      - 'WebClient-v[0-9]+.[0-9]+.[0-9]+'

  # Manual trigger option
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.2.3). Leave empty to use latest commit.'
        required: false
        type: string
      grpc_url:
        description: 'gRPC Server URL (default: https://api.hushnetwork.social)'
        required: false
        type: string
        default: 'https://api.hushnetwork.social'
      debug_logging:
        description: 'Enable debug logging (true/false)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: hushnetwork-social/hush-webclient

jobs:
  # ============================================
  # CI GATE — must pass before deploying
  # ============================================
  ci:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Lint
      run: npm run lint

    - name: Test
      run: npm run test:run

    - name: Build
      run: npm run build

  # ============================================
  # BUILD, PUSH & DEPLOY — only after CI passes
  # ============================================
  build-and-deploy:
    needs: [ci]
    runs-on: ubuntu-latest
    environment: HushServerNode AWS CD

    permissions:
      contents: read
      packages: write

    steps:
      # ============================================
      # CHECKOUT & VERSION EXTRACTION
      # ============================================

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ inputs.version }}" ]]; then
              VERSION="${{ inputs.version }}"
            else
              VERSION="manual-$(date +%Y%m%d-%H%M%S)"
            fi
          else
            # Extract version from tag: WebClient-v1.2.3 -> v1.2.3
            VERSION=${GITHUB_REF#refs/tags/WebClient-}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # ============================================
      # BUILD & PUSH DOCKER IMAGE
      # ============================================

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          build-args: |
            APP_VERSION=${{ steps.version.outputs.version }}
            NEXT_PUBLIC_GRPC_URL=${{ inputs.grpc_url || 'https://api.hushnetwork.social' }}
            NEXT_PUBLIC_DEBUG_LOGGING=${{ inputs.debug_logging || 'false' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary - Image pushed
        run: |
          echo "### Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # DEPLOY TO AWS LIGHTSAIL
      # ============================================

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/lightsail.pem
          chmod 600 ~/.ssh/lightsail.pem

          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to AWS Lightsail
        env:
          SSH_HOST: ${{ secrets.AWS_HOST }}
          SSH_USER: ${{ secrets.AWS_SSH_USER }}
          IMAGE_TAG: ${{ steps.version.outputs.version }}
          GRPC_SERVER_URL: ${{ inputs.grpc_url || 'https://api.hushnetwork.social' }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        run: |
          ssh -i ~/.ssh/lightsail.pem -o ServerAliveInterval=30 -o ServerAliveCountMax=10 ${SSH_USER}@${SSH_HOST} "IMAGE_TAG=${IMAGE_TAG}" "GRPC_SERVER_URL=${GRPC_SERVER_URL}" "GHCR_TOKEN=${GHCR_TOKEN}" "GHCR_IMAGE=${GHCR_IMAGE}" 'bash -s' << 'DEPLOY_SCRIPT'
            set -e

            echo "Starting Hush Web Client deployment of version ${IMAGE_TAG}..."

            # Login to GHCR
            echo "Logging in to GitHub Container Registry..."
            echo "${GHCR_TOKEN}" | sudo docker login ghcr.io -u github --password-stdin

            # Pull the new image
            echo "Pulling new image..."
            sudo docker pull ${GHCR_IMAGE}:${IMAGE_TAG}

            # Stop and remove any container using port 3001 (could be landing, old browser, or old webclient)
            echo "Stopping any container on port 3001..."
            CONTAINER_ON_PORT=$(sudo docker ps --filter "publish=3001" -q)
            if [ -n "$CONTAINER_ON_PORT" ]; then
              sudo docker stop $CONTAINER_ON_PORT || true
              sudo docker rm $CONTAINER_ON_PORT || true
            fi

            # Also clean up any old containers by name pattern
            sudo docker ps -aq --filter "name=HushNetworkChatApp" | xargs -r sudo docker rm -f || true
            sudo docker ps -aq --filter "name=HushNetworkBrowser" | xargs -r sudo docker rm -f || true
            sudo docker ps -aq --filter "name=HushWebClient" | xargs -r sudo docker rm -f || true

            # Start new container with version in name
            # GRPC_SERVER_URL connects API routes to HushNetworkNode via NGINX proxy
            CONTAINER_NAME="HushWebClient_${IMAGE_TAG}"
            GRPC_URL="${GRPC_SERVER_URL:-https://api.hushnetwork.social}"
            echo "Starting new container: ${CONTAINER_NAME}..."
            echo "gRPC Server URL: ${GRPC_URL}"
            sudo docker run -d \
              --name ${CONTAINER_NAME} \
              --restart always \
              --network HushNetwork \
              -e GRPC_SERVER_URL=${GRPC_URL} \
              -p 127.0.0.1:3001:3000 \
              ${GHCR_IMAGE}:${IMAGE_TAG}

            # Verify container is running
            echo "Verifying deployment..."
            sleep 5
            if sudo docker ps | grep -q "${CONTAINER_NAME}"; then
              echo "${CONTAINER_NAME} is running!"
              sudo docker ps --filter "name=HushWebClient" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "Container failed to start!"
              sudo docker logs ${CONTAINER_NAME} --tail 50
              exit 1
            fi

            echo "Hush Web Client deployment complete!"
          DEPLOY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/lightsail.pem

      - name: Deployment Summary
        run: |
          echo "### Hush Web Client Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** \`HushWebClient_${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** AWS Lightsail (Frankfurt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** \`https://chat.hushnetwork.social\`" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # TRIGGER DESKTOP & MOBILE BUILDS
      # ============================================

      - name: Trigger Tauri Desktop build
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GHCR_TOKEN }}
          event-type: build-tauri
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "triggered_by": "webclient"}'

      - name: Trigger Android build
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GHCR_TOKEN }}
          event-type: build-android
          client-payload: '{"version": "${{ steps.version.outputs.version }}", "triggered_by": "webclient"}'

      - name: Triggered builds note
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered Downstream Builds" >> $GITHUB_STEP_SUMMARY
          echo "- Tauri Desktop (Windows MSI)" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [Actions](https://github.com/Hushnetwork-social/hush-web-client/actions) for build status." >> $GITHUB_STEP_SUMMARY
